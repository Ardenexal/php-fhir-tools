---
layout: default
title: FHIRPath Evaluator Demo
permalink: /demos/fhirpath/
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

<style>
    .fhirpath-demo {
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1rem;
    }

    .demo-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .demo-header h1 {
        color: var(--color-primary);
        margin-bottom: 0.5rem;
    }

    .demo-controls {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .demo-controls select {
        padding: 0.5rem 1rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        background: var(--color-background);
        color: var(--color-text);
        font-size: 0.9rem;
        cursor: pointer;
    }

    .demo-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .demo-panel {
        background: var(--color-background);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1rem;
    }

    .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--color-border);
    }

    .panel-title {
        font-weight: 600;
        color: var(--color-text);
        font-size: 1.1rem;
    }

    .demo-textarea {
        width: 100%;
        min-height: 400px;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        resize: vertical;
        background: var(--color-surface);
        color: var(--color-text);
    }

    .expression-input-group {
        margin-bottom: 1rem;
    }

    .expression-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        background: var(--color-surface);
        color: var(--color-text);
    }

    .expression-hint {
        font-size: 0.85rem;
        color: var(--color-text-light);
        margin-top: 0.25rem;
    }

    .demo-actions {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .demo-button {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-base);
    }

    .button-primary {
        background: var(--color-primary);
        color: white;
    }

    .button-primary:hover {
        background: var(--color-primary-dark);
        transform: translateY(-1px);
    }

    .button-secondary {
        background: var(--color-secondary);
        color: white;
    }

    .button-secondary:hover {
        background: var(--color-secondary-dark);
    }

    .button-outline {
        background: transparent;
        color: var(--color-primary);
        border: 1px solid var(--color-primary);
    }

    .button-outline:hover {
        background: var(--color-primary);
        color: white;
    }

    .result-display {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: 1rem;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }

    .result-item {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: var(--color-background);
        border-left: 3px solid var(--color-primary);
        border-radius: var(--radius-sm);
    }

    .result-type {
        font-weight: 600;
        color: var(--color-primary);
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
    }

    .result-value {
        color: var(--color-text);
        word-break: break-all;
    }

    .execution-time {
        font-size: 0.85rem;
        color: var(--color-text-light);
        margin-top: 0.5rem;
        text-align: right;
    }

    .status-message {
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
        display: none;
    }

    .status-message.show {
        display: block;
    }

    .status-loading {
        background: var(--color-info-bg);
        color: var(--color-info);
        border-left: 4px solid var(--color-info);
    }

    .status-success {
        background: var(--color-success-bg);
        color: var(--color-success);
        border-left: 4px solid var(--color-success);
    }

    .status-error {
        background: var(--color-error-bg);
        color: var(--color-error);
        border-left: 4px solid var(--color-error);
    }

    .outcome-display {
        background: var(--color-warning-bg);
        border: 1px solid var(--color-warning);
        border-radius: var(--radius-md);
        padding: 1rem;
        margin-bottom: 1rem;
        display: none;
    }

    .outcome-display.show {
        display: block;
    }

    .outcome-title {
        font-weight: 600;
        color: var(--color-warning-dark);
        margin-bottom: 0.5rem;
    }

    .outcome-content {
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        color: var(--color-text);
    }

    .syntax-reference {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 1rem;
        margin-bottom: 1rem;
    }

    .reference-toggle {
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: var(--color-primary);
        padding: 0.5rem;
    }

    .reference-content {
        display: none;
        padding: 1rem;
        margin-top: 0.5rem;
    }

    .reference-content.show {
        display: block;
    }

    .reference-section {
        margin-bottom: 1rem;
    }

    .reference-section h4 {
        color: var(--color-primary);
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .reference-section ul {
        list-style: none;
        padding-left: 1rem;
    }

    .reference-section li {
        padding: 0.25rem 0;
        font-size: 0.9rem;
    }

    .reference-section code {
        background: var(--color-background);
        padding: 0.2rem 0.4rem;
        border-radius: var(--radius-sm);
        font-size: 0.85rem;
    }

    .info-section {
        background: var(--color-info-bg);
        border-left: 4px solid var(--color-info);
        padding: 1rem;
        border-radius: var(--radius-md);
        margin-bottom: 1rem;
    }

    .info-section h3 {
        color: var(--color-info-dark);
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }

    .info-section ul {
        margin-left: 1.5rem;
        font-size: 0.9rem;
    }

    .info-section li {
        margin-bottom: 0.25rem;
    }

    @media (max-width: 768px) {
        .demo-layout {
            grid-template-columns: 1fr;
        }

        .demo-controls {
            flex-direction: column;
        }

        .demo-controls select {
            width: 100%;
        }

        .demo-textarea {
            min-height: 250px;
        }
    }

    /* PHP Status Styles */
    .php-status {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-md);
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .status-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--color-border);
        transition: all 0.3s ease;
    }

    .status-indicator.ready {
        background: #22c55e;
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
    }

    .status-indicator.initializing {
        background: #eab308;
        animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }

    .status-details {
        display: flex;
        gap: 1rem;
        font-size: 0.85rem;
        color: var(--color-text-light);
    }
</style>

<div class="fhirpath-demo">
    <div class="demo-header">
        <h1>FHIRPath Evaluator</h1>
        <p>Test FHIRPath expressions against FHIR resources in real-time</p>
    </div>

    <div class="info-section">
        <h3>üìñ How to Use</h3>
        <ul>
            <li>Load an example resource or paste your own FHIR JSON</li>
            <li>Select an expression from the library or write your own FHIRPath expression</li>
            <li>Click "Evaluate" or press Ctrl+Enter to run the expression</li>
            <li>View results with type information and execution time</li>
            <li>Refer to the syntax guide below for expression help</li>
        </ul>
    </div>

    <div class="demo-controls">
        <select id="exampleSelect">
            <option value="">Load Example Resource...</option>
            <option value="patient-simple">Patient (Simple)</option>
            <option value="patient-complex">Patient (Complex)</option>
            <option value="observation-vital-signs">Observation (Vital Signs)</option>
            <option value="bundle-transaction">Bundle (Transaction)</option>
            <option value="medication-request">Medication Request</option>
            <option value="practitioner">Practitioner</option>
        </select>

        <select id="expressionLibrary">
            <option value="">Expression Library...</option>
            <optgroup label="Basic Paths">
                <option value="name.given">name.given - Get given names</option>
                <option value="name.family">name.family - Get family names</option>
                <option value="telecom.value">telecom.value - Get contact values</option>
                <option value="birthDate">birthDate - Get birth date</option>
            </optgroup>
            <optgroup label="Collections">
                <option value="name.family.first()">name.family.first() - First family name</option>
                <option value="identifier.where(system='http://hospital.org')">identifier.where(...) - Filter identifiers</option>
                <option value="telecom.where(system='phone')">telecom.where(system='phone') - Phone numbers</option>
            </optgroup>
            <optgroup label="Existence & Empty">
                <option value="name.exists()">name.exists() - Check if name exists</option>
                <option value="deceased.empty()">deceased.empty() - Check if not deceased</option>
                <option value="telecom.exists()">telecom.exists() - Has telecom</option>
            </optgroup>
            <optgroup label="Functions">
                <option value="name.count()">name.count() - Count names</option>
                <option value="identifier.select(value)">identifier.select(value) - Extract values</option>
                <option value="telecom.all(system.exists())">telecom.all(...) - All have system</option>
            </optgroup>
            <optgroup label="Type Operations">
                <option value="name.ofType(HumanName)">ofType(HumanName) - Filter by type</option>
                <option value="value.is(Quantity)">is(Quantity) - Type check</option>
            </optgroup>
        </select>
    </div>

    <div class="php-status" id="phpStatus">
        <div class="status-badge">
            <span class="status-indicator" id="phpIndicator"></span>
            <span id="phpStatusText">PHP Runtime: Not initialized</span>
        </div>
        <div class="status-details">
            <span id="phpVersion"></span>
            <span id="phpMode"></span>
        </div>
    </div>

    <div id="statusMessage" class="status-message"></div>
    <div id="outcomeDisplay" class="outcome-display">
        <div class="outcome-title">‚ö†Ô∏è OperationOutcome</div>
        <pre id="outcomeContent" class="outcome-content"></pre>
    </div>

    <div class="demo-layout">
        <div class="demo-panel">
            <div class="panel-header">
                <span class="panel-title">FHIR Resource (JSON)</span>
            </div>
            <textarea id="resourceInput" class="demo-textarea" placeholder="Paste FHIR resource JSON here or load an example...">{
  "resourceType": "Patient",
  "id": "example",
  "name": [
    {
      "use": "official",
      "family": "Smith",
      "given": ["John", "Jacob"]
    }
  ],
  "telecom": [
    {
      "system": "phone",
      "value": "555-1234",
      "use": "home"
    }
  ],
  "birthDate": "1974-12-25",
  "gender": "male"
}</textarea>
        </div>

        <div class="demo-panel">
            <div class="panel-header">
                <span class="panel-title">FHIRPath Expression & Results</span>
            </div>
            
            <div class="expression-input-group">
                <input 
                    type="text" 
                    id="expressionInput" 
                    class="expression-input" 
                    placeholder="Enter FHIRPath expression (e.g., name.given)"
                    value="name.given"
                />
                <div class="expression-hint">Press Ctrl+Enter to evaluate</div>
            </div>

            <div class="demo-actions">
                <button id="evaluateBtn" class="demo-button button-primary">‚ñ∂Ô∏è Evaluate</button>
                <button id="clearExpressionBtn" class="demo-button button-secondary">Clear Expression</button>
                <button id="copyResultBtn" class="demo-button button-outline">üìã Copy Results</button>
            </div>

            <div id="resultDisplay" class="result-display">
                <div style="text-align: center; color: var(--color-text-light); padding: 2rem;">
                    Results will appear here after evaluation
                </div>
            </div>

            <div id="executionTime" class="execution-time"></div>
        </div>
    </div>

    <div class="syntax-reference">
        <div class="reference-toggle" id="syntaxToggle">
            <span>üìö FHIRPath Syntax Reference</span>
            <span>‚ñº</span>
        </div>
        <div class="reference-content" id="syntaxContent">
            <div class="reference-section">
                <h4>Basic Path Navigation</h4>
                <ul>
                    <li><code>name</code> - Access name element</li>
                    <li><code>name.given</code> - Nested access</li>
                    <li><code>name[0]</code> - Array index</li>
                </ul>
            </div>

            <div class="reference-section">
                <h4>Collection Functions</h4>
                <ul>
                    <li><code>first()</code> - First element</li>
                    <li><code>last()</code> - Last element</li>
                    <li><code>count()</code> - Count elements</li>
                    <li><code>empty()</code> - Check if empty</li>
                    <li><code>exists()</code> - Check if exists</li>
                </ul>
            </div>

            <div class="reference-section">
                <h4>Filtering</h4>
                <ul>
                    <li><code>where(condition)</code> - Filter collection</li>
                    <li><code>select(expression)</code> - Transform elements</li>
                    <li><code>all(condition)</code> - All match</li>
                    <li><code>any(condition)</code> - Any match</li>
                </ul>
            </div>

            <div class="reference-section">
                <h4>Type Operations</h4>
                <ul>
                    <li><code>ofType(Type)</code> - Filter by type</li>
                    <li><code>is(Type)</code> - Check type</li>
                    <li><code>as(Type)</code> - Cast to type</li>
                </ul>
            </div>

            <div class="reference-section">
                <h4>Comparison Operators</h4>
                <ul>
                    <li><code>=</code> - Equal</li>
                    <li><code>!=</code> - Not equal</li>
                    <li><code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code> - Comparison</li>
                </ul>
            </div>

            <div class="reference-section">
                <h4>Boolean Operators</h4>
                <ul>
                    <li><code>and</code> - Logical AND</li>
                    <li><code>or</code> - Logical OR</li>
                    <li><code>not</code> - Logical NOT</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { 
        createOperationOutcome, 
        validationError, 
        structureError, 
        formatOperationOutcome,
        processingError
    } from '{{ "/assets/js/utils/operation-outcome.js" | relative_url }}';
    
    import { fhirClient } from '{{ "/assets/js/php-wasm/fhir-client.js" | relative_url }}';

    // PHP initialization state
    let phpInitialized = false;
    let phpInitializing = false;

    // DOM elements
    const exampleSelect = document.getElementById('exampleSelect');
    const expressionLibrary = document.getElementById('expressionLibrary');
    const resourceInput = document.getElementById('resourceInput');
    const expressionInput = document.getElementById('expressionInput');
    const evaluateBtn = document.getElementById('evaluateBtn');
    const clearExpressionBtn = document.getElementById('clearExpressionBtn');
    const copyResultBtn = document.getElementById('copyResultBtn');
    const resultDisplay = document.getElementById('resultDisplay');
    const executionTime = document.getElementById('executionTime');
    const statusMessage = document.getElementById('statusMessage');
    const outcomeDisplay = document.getElementById('outcomeDisplay');
    const outcomeContent = document.getElementById('outcomeContent');
    const syntaxToggle = document.getElementById('syntaxToggle');
    const syntaxContent = document.getElementById('syntaxContent');

    // Expression history
    let expressionHistory = [];

    // Load example resource
    exampleSelect.addEventListener('change', async (e) => {
        const value = e.target.value;
        if (!value) return;

        try {
            showStatus('Loading example resource...', 'loading');
            const response = await fetch(`{{ "/assets/data/examples/" | relative_url }}${value}.json`);
            if (!response.ok) throw new Error('Failed to load example');
            
            const data = await response.json();
            resourceInput.value = JSON.stringify(data, null, 2);
            showStatus(`‚úì Loaded ${value}`, 'success');
            hideOutcome();
        } catch (error) {
            const outcome = structureError('Failed to load example', error.message);
            displayOutcome(outcome);
            showStatus('Failed to load example', 'error');
        }
    });

    // Load expression from library
    expressionLibrary.addEventListener('change', (e) => {
        const value = e.target.value;
        if (!value) return;
        
        expressionInput.value = value;
        expressionLibrary.value = '';
    });

    // Evaluate expression
    evaluateBtn.addEventListener('click', evaluateExpression);
    
    // Keyboard shortcut
    expressionInput.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            evaluateExpression();
        }
    });

    // Ensure PHP is initialized
    async function ensurePhpInitialized() {
        if (phpInitialized) return;
        if (phpInitializing) {
            // Wait for ongoing initialization
            while (phpInitializing) {
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            return;
        }

        phpInitializing = true;
        updatePhpStatus('initializing', 'Initializing...', '', '');

        try {
            await fhirClient.initialize((progress) => {
                console.log(`[PHP-WASM] ${progress.stage}: ${progress.message}`);
                updatePhpStatus('initializing', `Initializing: ${progress.message}`, '', '');
            });

            const phpVersion = fhirClient.getPhpVersion();
            updatePhpStatus('ready', 'Ready', `Version: ${phpVersion}`, 'Mode: Mock');
            phpInitialized = true;
        } catch (error) {
            updatePhpStatus('error', 'Initialization failed', '', '');
            throw new Error(`PHP initialization failed: ${error.message}`);
        } finally {
            phpInitializing = false;
        }
    }

    function updatePhpStatus(state, statusText, version, mode) {
        const indicator = document.getElementById('phpIndicator');
        const statusTextEl = document.getElementById('phpStatusText');
        const versionEl = document.getElementById('phpVersion');
        const modeEl = document.getElementById('phpMode');

        indicator.className = 'status-indicator' + (state === 'ready' ? ' ready' : state === 'initializing' ? ' initializing' : '');
        statusTextEl.textContent = `PHP Runtime: ${statusText}`;
        versionEl.textContent = version;
        modeEl.textContent = mode;
    }

    async function evaluateExpression() {
        const resource = resourceInput.value.trim();
        const expression = expressionInput.value.trim();

        if (!resource) {
            const outcome = validationError('Resource is required', 'Resource');
            displayOutcome(outcome);
            return;
        }

        if (!expression) {
            const outcome = validationError('Expression is required', 'Expression');
            displayOutcome(outcome);
            return;
        }

        try {
            // Ensure PHP is initialized before evaluation
            await ensurePhpInitialized();
            
            showStatus('Evaluating FHIRPath expression...', 'loading');
            hideOutcome();

            // Parse resource JSON
            let parsedResource;
            try {
                parsedResource = JSON.parse(resource);
            } catch (error) {
                const outcome = structureError('Invalid JSON format', error.message);
                displayOutcome(outcome);
                showStatus('Invalid JSON', 'error');
                return;
            }

            // Validate resource type
            if (!parsedResource.resourceType) {
                const outcome = validationError('Resource must have resourceType', 'Resource.resourceType');
                displayOutcome(outcome);
                showStatus('Invalid FHIR resource', 'error');
                return;
            }

            const startTime = performance.now();

            // Use PHP-WASM client to evaluate FHIRPath
            const result = await fhirClient.evaluateFHIRPath(parsedResource, expression);

            const endTime = performance.now();
            const duration = (endTime - startTime).toFixed(2);

            displayResults(result, duration);
            addToHistory(expression);
            showStatus(`‚úì Evaluation complete in ${duration}ms`, 'success');

        } catch (error) {
            const outcome = createOperationOutcome({
                severity: 'error',
                code: 'processing',
                details: 'FHIRPath evaluation failed',
                diagnostics: error.message,
                expression: [expression]
            });
            displayOutcome(outcome);
            showStatus('Evaluation failed', 'error');
        }
    }

    function getType(value) {
        if (value === null) return 'null';
        if (value === undefined) return 'undefined';
        if (Array.isArray(value)) return 'Array';
        if (typeof value === 'object') return 'Object';
        if (typeof value === 'string') return 'String';
        if (typeof value === 'number') return 'Number';
        if (typeof value === 'boolean') return 'Boolean';
        return 'Unknown';
    }

    function displayResults(result, duration) {
        executionTime.textContent = `Execution time: ${duration}ms`;

        if (result.value === undefined || result.value === null) {
            resultDisplay.innerHTML = `
                <div style="text-align: center; color: var(--color-text-light); padding: 2rem;">
                    No results (expression evaluated to empty)
                </div>
            `;
            return;
        }

        let html = '';
        const values = Array.isArray(result.value) ? result.value : [result.value];

        values.forEach((val, idx) => {
            const displayValue = typeof val === 'object' ? 
                JSON.stringify(val, null, 2) : String(val);
            const type = getType(val);

            html += `
                <div class="result-item">
                    <div class="result-type">[${idx + 1}] ${type}</div>
                    <div class="result-value">${escapeHtml(displayValue)}</div>
                </div>
            `;
        });

        html += `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); font-size: 0.85rem; color: var(--color-text-light);">
            Total results: ${values.length}
        </div>`;

        resultDisplay.innerHTML = html;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function addToHistory(expression) {
        if (!expressionHistory.includes(expression)) {
            expressionHistory.unshift(expression);
            if (expressionHistory.length > 10) {
                expressionHistory.pop();
            }
        }
    }

    // Clear expression
    clearExpressionBtn.addEventListener('click', () => {
        expressionInput.value = '';
        resultDisplay.innerHTML = `
            <div style="text-align: center; color: var(--color-text-light); padding: 2rem;">
                Results will appear here after evaluation
            </div>
        `;
        executionTime.textContent = '';
        hideStatus();
        hideOutcome();
    });

    // Copy results
    copyResultBtn.addEventListener('click', () => {
        const text = resultDisplay.textContent;
        navigator.clipboard.writeText(text).then(() => {
            showStatus('‚úì Results copied to clipboard', 'success');
        });
    });

    // Toggle syntax reference
    syntaxToggle.addEventListener('click', () => {
        syntaxContent.classList.toggle('show');
        const arrow = syntaxToggle.querySelector('span:last-child');
        arrow.textContent = syntaxContent.classList.contains('show') ? '‚ñ≤' : '‚ñº';
    });

    // Status messages
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `status-message status-${type} show`;
    }

    function hideStatus() {
        statusMessage.className = 'status-message';
    }

    // OperationOutcome display
    function displayOutcome(outcome) {
        outcomeContent.textContent = formatOperationOutcome(outcome);
        outcomeDisplay.classList.add('show');
    }

    function hideOutcome() {
        outcomeDisplay.classList.remove('show');
    }

    // Note to user
    console.log('%c‚ö†Ô∏è FHIRPath Evaluator Demo', 'font-size: 16px; font-weight: bold; color: #f59e0b;');
    console.log('%cThis is a placeholder implementation. Full FHIRPath evaluation with php-wasm coming soon!', 'font-size: 14px; color: #6b7280;');
</script>
