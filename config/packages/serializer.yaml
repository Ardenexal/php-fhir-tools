# Symfony Serializer Configuration for FHIR Tools
framework:
    serializer:
        enabled: true
        # Enable attribute mapping for FHIR classes
        mapping:
            paths:
                - '%kernel.project_dir%/src/Attributes'
        # Configure default context for FHIR serialization
        default_context:
            # Enable circular reference handling for FHIR resources
            circular_reference_handler: 'serializer.circular_reference_handler'
            # Set maximum depth to prevent infinite recursion
            enable_max_depth: true
            # Skip null values by default (FHIR specification requirement)
            skip_null_values: true
            # Preserve empty objects for FHIR compliance
            preserve_empty_objects: false

# FHIR-specific serializer services
services:
    # Circular reference handler for FHIR resources
    serializer.circular_reference_handler:
        class: Symfony\Component\Serializer\Normalizer\ObjectNormalizer
        arguments:
            - null # class metadata factory
            - null # name converter
            - null # property accessor
            - null # property type extractor
            - null # class discriminator mapping
            - null # callable resolver
            - [] # default context

    # FHIR Metadata Cache - Singleton service for performance
    fhir.metadata_cache:
        class: Ardenexal\FHIRTools\Serialization\FHIRMetadataCache
        public: false

    # FHIR Metadata Extractor
    fhir.metadata_extractor:
        class: Ardenexal\FHIRTools\Serialization\FHIRMetadataExtractor
        arguments:
            $cache: '@fhir.metadata_cache'
        public: false

    # FHIR Type Resolver with default mappings
    fhir.type_resolver:
        class: Ardenexal\FHIRTools\Serialization\FHIRTypeResolver
        arguments:
            $resourceTypeMapping: '%fhir.resource_type_mapping%'
            $choiceElementMapping: '%fhir.choice_element_mapping%'
            $referenceTypeMapping: '%fhir.reference_type_mapping%'
            $extensionValueMapping: '%fhir.extension_value_mapping%'
            $complexTypeMapping: '%fhir.complex_type_mapping%'
        public: false

    # FHIR Resource Normalizer
    fhir.normalizer.resource:
        class: Ardenexal\FHIRTools\Serialization\FHIRResourceNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
            $typeResolver: '@fhir.type_resolver'
        tags:
            - { name: 'serializer.normalizer', priority: 100 }
        public: false

    # FHIR Complex Type Normalizer
    fhir.normalizer.complex_type:
        class: Ardenexal\FHIRTools\Serialization\FHIRComplexTypeNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
            $typeResolver: '@fhir.type_resolver'
        tags:
            - { name: 'serializer.normalizer', priority: 90 }
        public: false

    # FHIR Primitive Type Normalizer
    fhir.normalizer.primitive:
        class: Ardenexal\FHIRTools\Serialization\FHIRPrimitiveTypeNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
        tags:
            - { name: 'serializer.normalizer', priority: 80 }
        public: false

    # FHIR Backbone Element Normalizer
    fhir.normalizer.backbone_element:
        class: Ardenexal\FHIRTools\Serialization\FHIRBackboneElementNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
        tags:
            - { name: 'serializer.normalizer', priority: 85 }
        public: false

    # Service aliases for easy access
    Ardenexal\FHIRTools\Serialization\FHIRMetadataExtractorInterface: '@fhir.metadata_extractor'
    Ardenexal\FHIRTools\Serialization\FHIRTypeResolverInterface: '@fhir.type_resolver'
    Ardenexal\FHIRTools\Serialization\FHIRMetadataCache: '@fhir.metadata_cache'

    # Version-specific service configurations
    # R4B Configuration
    fhir.r4b.type_resolver:
        class: Ardenexal\FHIRTools\Serialization\FHIRTypeResolver
        arguments:
            $resourceTypeMapping: '%fhir.r4b.resource_type_mapping%'
            $choiceElementMapping: '%fhir.r4b.choice_element_mapping%'
            $referenceTypeMapping: '%fhir.r4b.reference_type_mapping%'
            $extensionValueMapping: '%fhir.r4b.extension_value_mapping%'
            $complexTypeMapping: '%fhir.r4b.complex_type_mapping%'
        public: false

    fhir.r4b.normalizer.resource:
        class: Ardenexal\FHIRTools\Serialization\FHIRResourceNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
            $typeResolver: '@fhir.r4b.type_resolver'
        tags:
            - { name: 'serializer.normalizer', priority: 110 }
        public: false

    # R5 Configuration (future support)
    fhir.r5.type_resolver:
        class: Ardenexal\FHIRTools\Serialization\FHIRTypeResolver
        arguments:
            $resourceTypeMapping: '%fhir.r5.resource_type_mapping%'
            $choiceElementMapping: '%fhir.r5.choice_element_mapping%'
            $referenceTypeMapping: '%fhir.r5.reference_type_mapping%'
            $extensionValueMapping: '%fhir.r5.extension_value_mapping%'
            $complexTypeMapping: '%fhir.r5.complex_type_mapping%'
        public: false

    fhir.r5.normalizer.resource:
        class: Ardenexal\FHIRTools\Serialization\FHIRResourceNormalizer
        arguments:
            $metadataExtractor: '@fhir.metadata_extractor'
            $typeResolver: '@fhir.r5.type_resolver'
        tags:
            - { name: 'serializer.normalizer', priority: 105 }
        public: false

# FHIR Type Mapping Parameters
parameters:
    # Default FHIR type mappings (can be overridden per version)
    fhir.resource_type_mapping:
        Patient: 'Ardenexal\FHIRTools\Generated\FHIR\Patient'
        Observation: 'Ardenexal\FHIRTools\Generated\FHIR\Observation'
        # Add more resource mappings as needed

    fhir.choice_element_mapping:
        valueString: 'string'
        valueInteger: 'integer'
        valueBoolean: 'boolean'
        valueDecimal: 'decimal'
        valueDateTime: 'dateTime'
        # Add more choice element mappings as needed

    fhir.reference_type_mapping:
        Patient: 'Ardenexal\FHIRTools\Generated\FHIR\Patient'
        Practitioner: 'Ardenexal\FHIRTools\Generated\FHIR\Practitioner'
        Organization: 'Ardenexal\FHIRTools\Generated\FHIR\Organization'
        # Add more reference mappings as needed

    fhir.extension_value_mapping:
        valueString: 'string'
        valueInteger: 'integer'
        valueBoolean: 'boolean'
        valueCode: 'code'
        # Add more extension value mappings as needed

    fhir.complex_type_mapping:
        HumanName: 'Ardenexal\FHIRTools\Generated\FHIR\HumanName'
        Address: 'Ardenexal\FHIRTools\Generated\FHIR\Address'
        ContactPoint: 'Ardenexal\FHIRTools\Generated\FHIR\ContactPoint'
        # Add more complex type mappings as needed

    # R4B-specific mappings
    fhir.r4b.resource_type_mapping: '%fhir.resource_type_mapping%'
    fhir.r4b.choice_element_mapping: '%fhir.choice_element_mapping%'
    fhir.r4b.reference_type_mapping: '%fhir.reference_type_mapping%'
    fhir.r4b.extension_value_mapping: '%fhir.extension_value_mapping%'
    fhir.r4b.complex_type_mapping: '%fhir.complex_type_mapping%'

    # R5-specific mappings (placeholder for future support)
    fhir.r5.resource_type_mapping: '%fhir.resource_type_mapping%'
    fhir.r5.choice_element_mapping: '%fhir.choice_element_mapping%'
    fhir.r5.reference_type_mapping: '%fhir.reference_type_mapping%'
    fhir.r5.extension_value_mapping: '%fhir.extension_value_mapping%'
    fhir.r5.complex_type_mapping: '%fhir.complex_type_mapping%'