name: Pull Request

on:
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      XDEBUG_MODE: off
      COMPOSER_NO_INTERACTION: 1
    
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch full history for better diff analysis
        fetch-depth: 0
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: ctype, iconv, zip
    
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v4
      with:
        path: vendor
        key: ${{ runner.os }}-php-8.3-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-8.3-
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Validate composer files
      run: composer validate --strict
    
    - name: Check code style (Pint) - All Components
      run: composer run lint
    
    - name: Run PHPStan static analysis - All Components
      run: composer run phpstan
    
    - name: Run unit tests
      run: composer run test-unit -- --no-coverage
    
    - name: Run integration tests
      run: composer run test-integration -- --no-coverage
    
    - name: Run FHIR tests
      run: composer run test-fhir -- --no-coverage
    
    - name: Security audit
      run: composer audit
    
    - name: Check for code style violations
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "‚ùå Code style issues found. Please run 'composer run lint' locally and commit the changes."
          echo ""
          echo "Files that need formatting:"
          git status --porcelain
          echo ""
          echo "Diff of changes needed:"
          git diff
          exit 1
        else
          echo "‚úÖ Code style is compliant"
        fi
    
    # - name: Validate commit messages
    #   run: |
    #     # Check if commit messages follow conventional commits
    #     git log --oneline origin/main..HEAD | while read line; do
    #       commit_msg=$(echo "$line" | cut -d' ' -f2-)
    #       if ! echo "$commit_msg" | grep -qE '^(feat|fix|chore|test|docs|refactor|perf|style)(\(.+\))?: .+'; then
    #         echo "‚ùå Commit message does not follow conventional commits format: $commit_msg"
    #         echo "Expected format: type: description"
    #         echo "Valid types: feat, fix, chore, test, docs, refactor, perf, style"
    #         exit 1
    #       fi
    #     done
    #     echo "‚úÖ All commit messages follow conventional commits format"

  component-quality:
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      matrix:
        component: [bundle, codegen, serialization]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: ctype, iconv, zip
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Run ${{ matrix.component }} quality checks
      run: composer run quality:${{ matrix.component }}

  performance:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: ctype, iconv, zip
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Test command performance
      run: |
        echo "Testing basic command performance..."
        time php bin/console list > /dev/null
        echo "‚úÖ Command execution completed successfully"

  recipe-validation:
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: ctype, iconv, zip
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Validate Symfony Flex recipe
      run: composer run validate-recipe
    
    - name: Test recipe installation
      run: composer run test-recipe

  fhir-generation-test:
    runs-on: ubuntu-latest
    needs: [validate, component-quality]
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: ctype, iconv, zip, curl
    
    - name: Install dependencies
      run: composer install --prefer-dist --no-progress --no-suggest
    
    - name: Test FHIR Model Generation
      id: fhir-test
      run: |
        echo "üß™ Testing FHIR Model Generation..." >> fhir_output.txt
        echo "=================================" >> fhir_output.txt
        echo "" >> fhir_output.txt
        
        # Test with a smaller FHIR package for faster execution
        echo "üì¶ Generating FHIR models from hl7.fhir.r4b.core package..." >> fhir_output.txt
        echo "" >> fhir_output.txt
        
        # Capture both stdout and stderr, and measure execution time
        start_time=$(date +%s)
        
        if timeout 300 php bin/console fhir:generate --package=hl7.fhir.r4b.core -v >> fhir_output.txt 2>&1; then
          end_time=$(date +%s)
          execution_time=$((end_time - start_time))
          
          echo "" >> fhir_output.txt
          echo "‚úÖ **FHIR Generation Successful!**" >> fhir_output.txt
          echo "‚è±Ô∏è Execution time: ${execution_time} seconds" >> fhir_output.txt
          echo "" >> fhir_output.txt
          
          # Count generated files
          if [ -d "output" ]; then
            file_count=$(find output -name "*.php" | wc -l)
            echo "üìÅ Generated ${file_count} PHP model files" >> fhir_output.txt
            
            # Show some example generated files
            echo "" >> fhir_output.txt
            echo "üìã **Sample Generated Files:**" >> fhir_output.txt
            find output -name "*.php" | head -10 | while read file; do
              echo "- $(basename "$file")" >> fhir_output.txt
            done
            
            if [ $file_count -gt 10 ]; then
              echo "- ... and $((file_count - 10)) more files" >> fhir_output.txt
            fi
          fi
          
          echo "FHIR_SUCCESS=true" >> $GITHUB_OUTPUT
        else
          end_time=$(date +%s)
          execution_time=$((end_time - start_time))
          
          echo "" >> fhir_output.txt
          echo "‚ùå **FHIR Generation Failed**" >> fhir_output.txt
          echo "‚è±Ô∏è Execution time: ${execution_time} seconds (timed out at 300s)" >> fhir_output.txt
          echo "" >> fhir_output.txt
          echo "Please check the error output above for details." >> fhir_output.txt
          
          echo "FHIR_SUCCESS=false" >> $GITHUB_OUTPUT
        fi
        
        # Add system information
        echo "" >> fhir_output.txt
        echo "üñ•Ô∏è **System Information:**" >> fhir_output.txt
        echo "- PHP Version: $(php -v | head -n1)" >> fhir_output.txt
        echo "- Memory Limit: $(php -r 'echo ini_get("memory_limit");')" >> fhir_output.txt
        echo "- OS: $(uname -s) $(uname -r)" >> fhir_output.txt
    
    - name: Comment PR with FHIR Generation Results
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // Read the FHIR generation output
          let fhirOutput;
          try {
            fhirOutput = fs.readFileSync('fhir_output.txt', 'utf8');
          } catch (error) {
            fhirOutput = '‚ùå Could not read FHIR generation output file.';
          }
          
          // Determine if this is a success or failure
          const isSuccess = '${{ steps.fhir-test.outputs.FHIR_SUCCESS }}' === 'true';
          const emoji = isSuccess ? '‚úÖ' : '‚ùå';
          const status = isSuccess ? 'SUCCESS' : 'FAILED';
          
          // Create the comment body
          const commentBody = `## ${emoji} FHIR Model Generation Test ${status}
          
          This automated test validates that the FHIR model generation functionality works correctly with the changes in this PR.
          
          <details>
          <summary>üìã Click to view detailed output</summary>
          
          \`\`\`
          ${fhirOutput}
          \`\`\`
          
          </details>
          
          ---
          
          ${isSuccess ? 
            'üéâ The FHIR model generation completed successfully! The enhanced package management system is working correctly.' : 
            '‚ö†Ô∏è The FHIR model generation encountered issues. Please review the output above and fix any problems before merging.'
          }
          
          *This comment was automatically generated by the GitHub Actions workflow.*`;
          
          // Post the comment
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });